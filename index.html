<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Matt's URL Shortener & File Downloader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ... [same styles as before, plus these:] ... */
    .download-section {
      margin-top: 2em;
      padding: 1.3em 1em 1em 1em;
      background: #eaf6ff;
      border-radius: 1em;
      box-shadow: 0 3px 12px #2987eb14;
    }
    body.dark .download-section {
      background: #1b2838;
      color: #cfeaff;
    }
    .download-section h2 {
      margin-top: 0;
      color: var(--main-color);
      font-size: 1.3em;
      margin-bottom: 0.6em;
    }
    .download-table th, .download-table td {
      padding: 0.6em 0.2em;
      border-bottom: 1px solid #e0e7ef;
    }
    .download-table th {
      background: #c3e5ff;
      color: #1b2838;
    }
    body.dark .download-table th {
      background: #232a3a;
      color: #ffdc4f;
    }
    .download-btn {
      background: var(--main-color);
      color: #fff;
      padding: 0.35em 1em;
      border: none;
      border-radius: 0.8em;
      cursor: pointer;
      font-size: 1em;
      margin-left: 0.2em;
      transition: background 0.2s;
    }
    .download-btn:active { background: #1558b2; }
    .file-link {
      color: #1558b2;
      text-decoration: underline;
      word-break: break-all;
    }
    body.dark .file-link {
      color: #ffdc4f;
    }
    .download-searchbar {
      width: 100%;
      padding: 0.5em 1em;
      font-size: 1em;
      margin-bottom: 0.7em;
      border-radius: 1em;
      border: 1px solid #ccc;
      background: #fafbff;
      box-sizing: border-box;
      transition: border 0.3s;
    }
    body.dark .download-searchbar {
      background: #222c3a;
      color: #fff;
      border: 1px solid #444;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- [mode toggle, h1, howto, searchbar, short URL table as previous] -->
    <button class="mode-toggle" id="modeBtn" title="Toggle dark mode">
      <svg id="modeIcon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="7" fill="#222"></circle></svg>
    </button>
    <h1>
      <span class="icon">🔗</span>Matt's URL Shortener & File Downloader
    </h1>
    <div class="howto">
      <span class="badge">How to use</span>
      <ul>
        <li>直接在網址列輸入 <code>/你的短碼</code> 即可跳轉，例如：<b>/yt</b> → <a class="url-link" href="https://youtube.com/" target="_blank">YouTube</a></li>
        <li>點擊 <b>Copy</b> 可複製完整短網址</li>
        <li>下方可搜尋並下載檔案（OneDrive），點 <b>Download</b> 即可</li>
        <li>如需新增或修改短碼或檔案，請編輯 <code>urls.json</code> / <code>files.json</code> 並推送至 GitHub</li>
      </ul>
    </div>
    <input class="searchbar" id="search" type="text" placeholder="搜尋短碼或網址..." autocomplete="off">
    <table id="urlTable">
      <thead>
        <tr>
          <th>短碼</th>
          <th>目標網址</th>
          <th>完整連結</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="4" style="text-align:center;color:#aaa;">Loading...</td></tr>
      </tbody>
    </table>

    <!-- File Download Section -->
    <div class="download-section">
      <h2>📁 File Download Section (OneDrive)</h2>
      <input class="download-searchbar" id="fileSearch" type="text" placeholder="搜尋檔案短碼或下載連結..." autocomplete="off">

      <table class="download-table" id="fileTable">
        <thead>
          <tr>
            <th>檔案短碼</th>
            <th>下載連結</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="3" style="text-align:center;color:#aaa;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    // --- Dark mode ---
    function setMode(dark) {
      document.body.classList.toggle('dark', dark);
      document.getElementById('modeIcon').innerHTML = dark
        ? '<path d="M12 2a10 10 0 1 0 0 20c5.5 0 10-4.5 10-10A10 10 0 0 0 12 2zm0 2c4.4 0 8 3.6 8 8s-3.6 8-8 8a8 8 0 0 1 0-16z" fill="#ffdc4f"/>'
        : '<circle cx="12" cy="12" r="7" fill="#222"></circle>';
      localStorage.setItem('darkMode', dark ? '1' : '0');
    }
    document.getElementById('modeBtn').onclick = () => setMode(!document.body.classList.contains('dark'));
    setMode(localStorage.getItem('darkMode') === '1');

    // --- Load urls.json and render table ---
    const repoPath = window.location.pathname.split('/')[1] || 'URL';
    const jsonUrl = `/urls.json`;
    const tableBody = document.querySelector('#urlTable tbody');
    let urlMap = {}, allRows = [];
    function renderTable(filter='') {
      let rows = Object.entries(urlMap)
        .filter(([k,v]) => k.includes(filter) || v.includes(filter))
        .map(([key, dest]) => {
          const shortUrl = `${window.location.origin}/${repoPath}/${key}`;
          return `<tr>
            <td><span class="badge">${key}</span></td>
            <td><a class="url-link" href="${dest}" target="_blank">${dest}</a></td>
            <td><input type="text" value="${shortUrl}" readonly style="width:99%;font-size:0.96em"></td>
            <td>
              <button class="copy-btn" onclick="copyToClipboard('${shortUrl}', this)">Copy</button>
            </td>
          </tr>`;
        });
      tableBody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="4" style="text-align:center;color:#aaa;">No results</td></tr>`;
      allRows = rows;
    }
    fetch(jsonUrl)
      .then(r => r.json())
      .then(j => { urlMap = j; renderTable(); })
      .catch(() => { tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#e34;">Failed to load urls.json</td></tr>`; });
    document.getElementById('search').oninput = function() {
      renderTable(this.value.trim());
    };
    window.copyToClipboard = function(txt, btn) {
      navigator.clipboard.writeText(txt);
      btn.textContent = "Copied!";
      setTimeout(()=>{btn.textContent="Copy";}, 1200);
    };

    // --- File Download Section ---
    const filesJsonUrl = `/${repoPath}/files.json`;
    const fileTableBody = document.querySelector('#fileTable tbody');
    let fileMap = {}, fileRows = [];
    function renderFileTable(filter='') {
      let rows = Object.entries(fileMap)
        .filter(([k,v]) => k.includes(filter) || v.includes(filter))
        .map(([key, fileUrl]) => {
          return `<tr>
            <td><span class="badge">${key}</span></td>
            <td><a class="file-link" href="${fileUrl}" target="_blank">${fileUrl}</a></td>
            <td>
              <button class="download-btn" onclick="downloadFile('${fileUrl}')">Download</button>
              <button class="copy-btn" onclick="copyToClipboard('${fileUrl}', this)">Copy Link</button>
            </td>
          </tr>`;
        });
      fileTableBody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="3" style="text-align:center;color:#aaa;">No results</td></tr>`;
      fileRows = rows;
    }
    fetch(filesJsonUrl)
      .then(r => r.json())
      .then(j => { fileMap = j; renderFileTable(); })
      .catch(() => { fileTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#e34;">Failed to load files.json</td></tr>`; });
    document.getElementById('fileSearch').oninput = function() {
      renderFileTable(this.value.trim());
    };
    window.downloadFile = function(url) {
      window.open(url, "_blank");
    };
  </script>
</body>
</html>
