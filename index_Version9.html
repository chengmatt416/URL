<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Matt's URL Shortener & File Downloader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --main-color: #2987eb;
      --accent: #ffdc4f;
      --bg: #f5f6fa;
      --card: #fff;
      --dark-bg: #222;
      --dark-card: #333;
      --transition: 0.3s;
    }
    body {
      font-family: 'Noto Sans TC', 'Segoe UI', 'Arial', sans-serif;
      margin: 0; padding: 0;
      background: var(--bg);
      color: #222;
      transition: background var(--transition), color var(--transition);
    }
    .container {
      max-width: 680px;
      margin: 2em auto;
      box-shadow: 0 8px 24px #0001;
      background: var(--card);
      border-radius: 1.2em;
      padding: 2em 2em 1em 2em;
      position: relative;
      transition: background var(--transition);
    }
    h1 {
      font-size: 2.2em;
      margin-bottom: 0.2em;
      letter-spacing: 0.04em;
      color: var(--main-color);
      text-shadow: 1px 2px 10px #2987eb44;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .icon {
      font-size: 1.1em;
      vertical-align: middle;
      animation: bounce 1.3s infinite alternate;
      margin-right: 0.08em;
    }
    @keyframes bounce {
      0% { transform: translateY(0);}
      100% { transform: translateY(-6px);}
    }
    .mode-toggle {
      position: absolute;
      top: 1.2em; right: 2em;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      width: 2.2em; height: 2.2em;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: background var(--transition);
      box-shadow: 0 3px 10px #0002;
    }
    .mode-toggle svg {
      width: 1.2em; height: 1.2em;
    }
    .searchbar, .download-searchbar {
      width: 100%;
      padding: 0.6em 1em;
      font-size: 1.1em;
      margin-bottom: 1em;
      border-radius: 1em;
      border: 1px solid #ccc;
      background: #fafbff;
      box-sizing: border-box;
      transition: border var(--transition);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1em;
      background: inherit;
    }
    th, td {
      padding: 0.7em 0.4em;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      color: var(--main-color);
      font-weight: 700;
      background: #2987eb11;
    }
    .copy-btn, .download-btn {
      background: var(--accent);
      border: none;
      border-radius: 0.8em;
      padding: 0.3em 1em;
      cursor: pointer;
      font-size: 1em;
      margin-left: 0.2em;
      transition: background var(--transition);
    }
    .copy-btn:active, .download-btn:active { background: #ffe066; }
    .url-link, .file-link {
      color: #0079d1;
      text-decoration: underline;
      word-break: break-all;
    }
    .howto {
      background: #f7faff;
      border-radius: 0.9em;
      margin: 1.1em 0 0.7em 0;
      padding: 1em 1.2em;
      color: #444;
      font-size: 1.07em;
      line-height: 1.6;
      box-shadow: 0 3px 12px #2987eb14;
    }
    .badge {
      background: var(--main-color);
      color: #fff;
      padding: 0.2em 0.8em;
      border-radius: 0.7em;
      font-size: 0.95em;
      margin-right: 0.25em;
      letter-spacing: 0.04em;
    }
    .download-section {
      margin-top: 2em;
      padding: 1.3em 1em 1em 1em;
      background: #eaf6ff;
      border-radius: 1em;
      box-shadow: 0 3px 12px #2987eb14;
    }
    body.dark .container {
      background: var(--dark-card);
      box-shadow: 0 6px 30px #0006;
    }
    body.dark {
      background: var(--dark-bg);
      color: #eee;
    }
    body.dark .howto {
      background: #232a3a;
      color: #cfeaff;
    }
    body.dark .searchbar, body.dark .download-searchbar {
      background: #222c3a;
      color: #fff;
      border: 1px solid #444;
    }
    body.dark th {
      background: #1b2e47;
    }
    body.dark .copy-btn, body.dark .download-btn {
      background: #555;
      color: #ffdc4f;
    }
    body.dark .badge {
      background: #ffdc4f;
      color: #222;
    }
    body.dark .url-link, body.dark .file-link {
      color: #ffdc4f;
    }
    body.dark .download-section {
      background: #1b2838;
      color: #cfeaff;
    }
    @media (max-width: 650px) {
      .container { padding: 1em 0.4em; }
      .mode-toggle { right: 0.6em; }
      th, td { padding: 0.5em 0.1em;}
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="mode-toggle" id="modeBtn" title="Toggle dark mode">
      <svg id="modeIcon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="7" fill="#222"></circle></svg>
    </button>
    <h1>
      <span class="icon">🔗</span>Matt's URL Shortener & File Downloader
    </h1>
    <div class="howto">
      <span class="badge">How to use</span>
      <ul>
        <li>直接在網址列輸入 <code>/你的短碼</code> 即可跳轉，例如：<b>/yt</b> → <a class="url-link" href="https://youtube.com/" target="_blank">YouTube</a></li>
        <li>點擊 <b>Copy</b> 可複製完整短網址</li>
        <li>下方可搜尋並下載檔案（OneDrive/SharePoint），點 <b>Download</b> 即可</li>
        <li>如需新增或修改短碼或檔案，請編輯 <code>urls.json</code>/<code>files.json</code> 並推送至 GitHub</li>
      </ul>
    </div>
    <input class="searchbar" id="search" type="text" placeholder="搜尋短碼或網址..." autocomplete="off">
    <table id="urlTable">
      <thead>
        <tr>
          <th>短碼</th>
          <th>目標網址</th>
          <th>完整連結</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="4" style="text-align:center;color:#aaa;">Loading...</td></tr>
      </tbody>
    </table>

    <div class="download-section">
      <h2>📁 File Download Section (OneDrive/SharePoint)</h2>
      <input class="download-searchbar" id="fileSearch" type="text" placeholder="搜尋檔案短碼或下載連結..." autocomplete="off">
      <table class="download-table" id="fileTable">
        <thead>
          <tr>
            <th>檔案短碼</th>
            <th>下載連結</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="3" style="text-align:center;color:#aaa;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    // --- Dark mode ---
    function setMode(dark) {
      document.body.classList.toggle('dark', dark);
      document.getElementById('modeIcon').innerHTML = dark
        ? '<path d="M12 2a10 10 0 1 0 0 20c5.5 0 10-4.5 10-10A10 10 0 0 0 12 2zm0 2c4.4 0 8 3.6 8 8s-3.6 8-8 8a8 8 0 0 1 0-16z" fill="#ffdc4f"/>'
        : '<circle cx="12" cy="12" r="7" fill="#222"></circle>';
      localStorage.setItem('darkMode', dark ? '1' : '0');
    }
    document.getElementById('modeBtn').onclick = () => setMode(!document.body.classList.contains('dark'));
    setMode(localStorage.getItem('darkMode') === '1');

    // --- Load urls.json and render table ---
    const urlJson = `/urls.json`;
    const tableBody = document.querySelector('#urlTable tbody');
    let urlMap = {};
    function renderTable(filter='') {
      let rows = Object.entries(urlMap)
        .filter(([k,v]) => k.includes(filter) || v.includes(filter))
        .map(([key, dest]) => {
          const shortUrl = `${window.location.origin}/${key}`;
          return `<tr>
            <td><span class="badge">${key}</span></td>
            <td><a class="url-link" href="${dest}" target="_blank">${dest}</a></td>
            <td><input type="text" value="${shortUrl}" readonly style="width:99%;font-size:0.96em"></td>
            <td>
              <button class="copy-btn" onclick="copyToClipboard('${shortUrl}', this)">Copy</button>
            </td>
          </tr>`;
        });
      tableBody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="4" style="text-align:center;color:#aaa;">No results</td></tr>`;
    }
    fetch(urlJson)
      .then(r => r.json())
      .then(j => { urlMap = j; renderTable(); })
      .catch(() => { tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#e34;">Failed to load urls.json</td></tr>`; });
    document.getElementById('search').oninput = function() {
      renderTable(this.value.trim());
    };

    // --- File Download Section ---
    const filesJsonUrl = `/files.json`;
    const fileTableBody = document.querySelector('#fileTable tbody');
    let fileMap = {};
    function addDownloadParam(url) {
      // If url already contains download=1, just return
      if (/([?&])download=1($|&)/.test(url)) return url;
      // Only auto-add for SharePoint/OneDrive links
      if (/sharepoint\.com|onedrive\.live\.com/i.test(url)) {
        return url + (url.includes('?') ? '&download=1' : '?download=1');
      }
      return url;
    }
    function renderFileTable(filter='') {
      let rows = Object.entries(fileMap)
        .filter(([k,v]) => k.includes(filter) || v.includes(filter))
        .map(([key, fileUrl]) => {
          const downloadUrl = addDownloadParam(fileUrl);
          return `<tr>
            <td><span class="badge">${key}</span></td>
            <td><a class="file-link" href="${downloadUrl}" target="_blank">${downloadUrl}</a></td>
            <td>
              <button class="download-btn" onclick="downloadFile('${downloadUrl}')">Download</button>
              <button class="copy-btn" onclick="copyToClipboard('${downloadUrl}', this)">Copy Link</button>
            </td>
          </tr>`;
        });
      fileTableBody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="3" style="text-align:center;color:#aaa;">No results</td></tr>`;
    }
    fetch(filesJsonUrl)
      .then(r => r.json())
      .then(j => { fileMap = j; renderFileTable(); })
      .catch(() => { fileTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#e34;">Failed to load files.json</td></tr>`; });
    document.getElementById('fileSearch').oninput = function() {
      renderFileTable(this.value.trim());
    };
    window.downloadFile = function(url) {
      window.open(url, "_blank");
    };
    window.copyToClipboard = function(txt, btn) {
      navigator.clipboard.writeText(txt);
      btn.textContent = "Copied!";
      setTimeout(()=>{btn.textContent="Copy Link";}, 1200);
    };
  </script>
</body>
</html>